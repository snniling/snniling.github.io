<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>webview与小程序通信</title>
</head>

<body>
  <button onclick="send()">发送</button>
  <button onclick="isminiapp()">判断是否在小程序内</button>
  <button onclick="onmessage()">开始监听小程序发送的消息</button>
  <button onclick="getminiappid()">我要调用小程序获取appid的api</button>
  <!-- h5 log 工具方便在小程序内查看h5的log-->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>
    eruda.init();
  </script>
  <!--引入https://appx/web-view.min.js， 如该 H5 页面需要同时在非支付宝客户端内使用，为避免该请求404，可参考以下写法 -->
  <script>
    if (navigator.userAgent.indexOf('AlipayClient') > -1) {
      document.writeln('<script src="https://appx/web-view.min.js"' + '>' + '<' + '/' + 'script>');
    }
  </script>
  <script>
    //发送消息
    function send() {
      my.postMessage({
        name: "h5发送测试web-view"
      });
    }
    //监听小程序发给h5页面的消息
    function onmessage() {
      my.onMessage = function (e) {
        console.log(e);
      }
    }
    //判断是否在小程序内
    function isminiapp() {
      my.getEnv(function (res) {
        console.log(res.miniprogram) // true  
      });
    }
    //h5内通过通信获取appid（先给小程序发送消息，表示h5内需要appid）
    function getminiappid() {
      my.postMessage({
        name: "getappid"
      });
    }
  </script>

<script src = "https://gw.alipayobjects.com/as/g/h5-lib/alipayjsapi/3.1.1/alipayjsapi.min.js"> </script> 
<button id = "test"> getAuthCode 网页2015071500171298</button>
<button id = "test2"> getAuthCode 小程序2017050307091553</button>
<button id="J_btn" class="btn btn-default">支付</button>
<a href="58bdc716879c255c94b7c1bf033112eb.html">测试</a>
<script>
 document.querySelector('#test').addEventListener('click',function(){
    window.location.href="http://d.alipay.com/i/index.html?iframeSrc=alipays%3A%2F%2Fplatformapi%2Fstartapp%3FappId%3D60000157%26appClearTop%3Dfalse%26startMultApp%3DYES%26sign_params%3Dalipay_sdk%253Dalipay-easysdk-java%2526app_id%253D2021003142691554%2526biz_content%253D%25257B%252522access_params%252522%25253A%25257B%252522channel%252522%25253A%252522ALIPAYAPP%252522%25257D%25252C%252522identity_params%252522%25253A%25257B%252522cert_no%252522%25253A%252522110229199812020104%252522%25257D%25252C%252522personal_product_code%252522%25253A%252522GENERAL_WITHHOLDING_P%252522%25252C%252522external_agreement_no%252522%25253A%2525222022110200001950%252522%25252C%252522product_code%252522%25253A%252522GENERAL_WITHHOLDING%252522%25252C%252522sign_scene%252522%25253A%252522INDUSTRY%25257CREPAYMENT%252522%25257D%2526charset%253Dutf-8%2526format%253Djson%2526method%253Dalipay.user.agreement.page.sign%2526notify_url%253Dhttps%25253A%25252F%25252Fopen-test.nbcb.com.cn%25253A11080%25252Fsit%25252FALIPAYDK%25252FsignAsynchNotify%2526return_url%253Dhttps%25253A%25252F%25252Faap-test.nbcb.com.cn%25253A20381%25252Ficcs%25252F%252523%25252Factivity%25252Fcar%25252Fresult%25253FbusinessType%25253D2%2526sign%253DSMv0jzP25An5LVYPMnCTQMn%25252BukbBoH%25252B9boogFKW9E7MHiFDi5HyFHswdXBX%25252BDcpN7lLZR4vHD7LxpAM86YSvoSv%25252FE1nXsYz2J0mYoipANxU8STN9qUf74377xBj%25252B2pDi50osRtf%25252BPAYOSWELoF2lnsilqU6ofO8IF1rLQeum9X2xLXvsQhAgvEWHPQ%25252BChPWU2aCZQcaPY0JcICRuSM59kJB6r0djcPcbgPMW3%25252F38vy0gUpIgoFmUQ7gG%25252FJlYO%25252BgagEQx32WMry9KD9CNnIowS5NpAiVykctn1a6JjGTJfGK7MLSoPKiJLZG2n2klORnOetuiyorbxwY8vEayb0gwyw%25253D%25253D%2526sign_type%253DRSA2%2526timestamp%253D2022-11-02%252B09%25253A06%25253A17%2526version%253D1.0"
ap.getAuthCode ({
      appId :  '2015071500171298' ,
      scopes : ['auth_user'],
   },function(res){
      ap.alert (JSON.stringify(res));
   });
});
document.querySelector('#test2').addEventListener('click',function(){
    ap.getAuthCode ({
      appId :  '2017050307091553' ,
      scopes : ['auth_user'],
   },function(res){
      ap.alert (JSON.stringify(res));
   });
});
var btn = document.querySelector('#J_btn');
  btn.addEventListener('click', function(){
    ap.tradePay({
      tradeNO: '2022101822001431711406468925'
    }, function(res){
      ap.alert(res.resultCode);
    });
  });
</script>
</body>
  
</html>
